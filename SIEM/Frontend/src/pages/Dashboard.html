<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SIEM Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #1e1e2f;
      color: #fff;
    }

    header {
      background: #111;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      color: #4fc3f7;
    }

    .filters {
      display: flex;
      gap: 10px;
    }

    select {
      padding: 5px 10px;
      border-radius: 5px;
      border: none;
      background: #2a2a3d;
      color: #fff;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      padding: 20px;
    }

    .card {
      background: #2a2a3d;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px #000;
    }

    .card h3 {
      margin-top: 0;
    }

    .big-number {
      font-size: 36px;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
    }

    .full-width {
      grid-column: span 3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: #fff;
    }

    table th, table td {
      padding: 8px 12px;
      border-bottom: 1px solid #444;
      text-align: left;
    }

    table th {
      background: #333;
    }
  </style>
</head>
<body>
  <header>
    <h1>SIEM Dashboard</h1>
    <div class="filters">
      <select id="levelSelect"></select>
      <select id="timeRange">
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
      </select>
      <select id="severityFilter">
        <option value="all">All Severities</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
    </div>
    <nav style="background:#222; padding:10px; display:flex; gap:15px;">
  <a href="dashboard.html" style="color:#fff; text-decoration:none;">Dashboard</a>
  <a href="alerts.html" style="color:#fff; text-decoration:none;">Alerts</a>
  <a href="search.html" style="color:#fff; text-decoration:none;">Search</a>
  <a href="incidents.html" style="color:#fff; text-decoration:none;">Incidents</a>
  <a href="reports.html" style="color:#fff; text-decoration:none;">Reports</a>
  <a href="settings.html" style="color:#fff; text-decoration:none;">Settings</a>
</nav>

  </header>

  <div class="container">
    <!-- Cards -->
    <div class="card">
      <h3>Total Logs</h3>
      <div id="totalLogs" class="big-number">0</div>
    </div>
    <div class="card">
      <h3>Total Alerts</h3>
      <div id="totalAlerts" class="big-number">0</div>
    </div>
    <div class="card">
      <h3>Total Incidents</h3>
      <div id="totalIncidents" class="big-number">0</div>
    </div>

    <!-- Charts -->
    <div class="card">
      <h3>Actions</h3>
      <canvas id="actionsChart"></canvas>
    </div>
    <div class="card">
      <h3>Auth Outcomes</h3>
      <canvas id="authChart"></canvas>
    </div>
    <div class="card">
      <h3>Logs Over Time</h3>
      <canvas id="timelineChart"></canvas>
    </div>

    <!-- Table -->
    <div class="card full-width">
      <h3>Recent Events</h3>
      <table>
        <thead>
          <tr>
            <th>@timestamp</th>
            <th>Action</th>
            <th>Source IP</th>
            <th>Destination IP</th>
            <th>User</th>
          </tr>
        </thead>
        <tbody id="recentLogs">
          <tr><td colspan="5">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let currentLevel = 1;

    async function loadLevels() {
      const res = await fetch('/api/levels');
      const levels = await res.json();
      const select = document.getElementById('levelSelect');
      select.innerHTML = '';
      levels.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.id.replace('level','');
        opt.textContent = l.name || l.id;
        select.appendChild(opt);
      });
      select.value = currentLevel;
      select.addEventListener('change', () => {
        currentLevel = select.value;
        loadData();
      });
    }

    async function loadData() {
      const res = await fetch(`/api/logs?level=${currentLevel}`);
      const data = await res.json();
      const logs = data.logs || [];

      // Total numbers
      document.getElementById('totalLogs').innerText = logs.length;
      document.getElementById('totalAlerts').innerText = logs.length; // placeholder
      document.getElementById('totalIncidents').innerText = Math.floor(logs.length / 5); // placeholder

      // Actions Chart
      const actions = {};
      logs.forEach(l => {
        const a = l["event.action"] || "unknown";
        actions[a] = (actions[a] || 0) + 1;
      });
      new Chart(document.getElementById('actionsChart'), {
        type: 'doughnut',
        data: { labels: Object.keys(actions), datasets: [{ data: Object.values(actions), backgroundColor: ['#4fc3f7','#f54291','#42f55d','#f5a742'] }] }
      });

      // Auth outcomes
      const outcomes = {};
      logs.forEach(l => {
        if (l["event.category"] === "authentication") {
          const o = l["event.outcome"] || "unknown";
          outcomes[o] = (outcomes[o] || 0) + 1;
        }
      });
      new Chart(document.getElementById('authChart'), {
        type: 'pie',
        data: { labels: Object.keys(outcomes), datasets: [{ data: Object.values(outcomes), backgroundColor: ['#42f5da','#f54266','#f5e642'] }] }
      });

      // Timeline
      const timeline = {};
      logs.forEach(l => {
        const day = new Date(l["@timestamp"]).toISOString().split("T")[0];
        timeline[day] = (timeline[day] || 0) + 1;
      });
      new Chart(document.getElementById('timelineChart'), {
        type: 'bar',
        data: { labels: Object.keys(timeline), datasets: [{ label:'Logs', data: Object.values(timeline), backgroundColor:'#4fc3f7' }] }
      });

      // Recent logs
      const tbody = document.getElementById('recentLogs');
      tbody.innerHTML = '';
      logs.slice(-10).reverse().forEach(l => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${l["@timestamp"]}</td>
          <td>${l["event.action"]||''}</td>
          <td>${l["source.ip"]||''}</td>
          <td>${l["destination.ip"]||''}</td>
          <td>${l["user.name"]||''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    loadLevels().then(loadData);
  </script>
</body>
</html>
